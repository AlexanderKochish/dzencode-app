name: CI Gatekeeper

on:
    pull_request:
        branches: ["main", "dev"]

jobs:
    check-code:
        name: Verify Code (Lint, Test, Build)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: "npm"

            - name: Install Dependencies
              run: npm ci

            - name: Generate Prisma
              run: npm run db:generate

            - name: Run Linter
              run: npm run lint

            - name: Run Tests (Раскомментируй, когда будут написаны тесты)
              run: npm run test

            - name: Test Build (Next.js & NestJS)

              run: npm run build
              env:
                  NODE_ENV: production
                  NEXT_PUBLIC_API_URL: http://localhost:3001
                  NEXT_PUBLIC_SOCKET_URL: http://localhost:3001
                  INTERNAL_API_URL: http://localhost:3001
                  DATABASE_URL: postgresql://fake:fake@localhost:5432/fake
